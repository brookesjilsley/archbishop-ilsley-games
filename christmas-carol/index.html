<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Carol Escape Room - Archbishop Ilsley Catholic School</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #2a5298 0%, #333 50%, #c41e3a 100%);
            min-height: 100vh;
            color: #333;
        }

        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .restart-fixed {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #c41e3a, #8b0000);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .restart-fixed:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .school-logo {
            color: #c41e3a;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        h1 {
            color: #2a5298;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            color: #333;
            font-size: 1.1em;
            font-style: italic;
        }

        .progress-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 30px;
            align-items: center;
        }

        .ghost-status {
            text-align: center;
            position: relative;
        }

        .ghost-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.3;
            transition: all 0.5s ease;
            display: block;
        }

        .ghost-icon.complete {
            opacity: 1;
            transform: scale(1.1);
        }

        .ghost-label {
            font-size: 0.9em;
            color: #333;
            font-weight: bold;
        }

        .key-collected {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 1.5em;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .key-collected.show {
            opacity: 1;
            animation: keyBounce 0.5s ease;
        }

        @keyframes keyBounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }

        .game-screen {
            background: white;
            border-radius: 15px;
            padding: 30px;
            flex-grow: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .game-screen.active {
            display: block;
        }

        .puzzle-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .ghost-title {
            background: linear-gradient(135deg, #2a5298, #c41e3a);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .puzzle-instruction {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #ffd700;
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        /* Puzzle Styles */
        .puzzle-area {
            min-height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px dashed #2a5298;
        }

        .jigsaw-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .puzzle-piece {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #ffd700, #ffeb3b);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            user-select: none;
        }

        .puzzle-piece:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .puzzle-piece.selected {
            border-color: #c41e3a;
            transform: scale(1.1);
        }

        .puzzle-piece.correct {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            pointer-events: none;
        }

        .drop-zone {
            min-height: 100px;
            border: 2px dashed #2a5298;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            transition: all 0.3s ease;
            background: #fff;
        }

        .drop-zone.highlight {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .drop-zone.filled {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            font-weight: bold;
        }

        .timeline-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .timeline-card {
            background: #ffd700;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            max-width: 200px;
            text-align: center;
            font-size: 0.9em;
        }

        .timeline-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .timeline-card.selected {
            border-color: #c41e3a;
            transform: scale(1.05);
        }

        .sharing-game {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .family-member {
            background: #fff;
            border: 2px solid #2a5298;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .food-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .food-item {
            background: #ffd700;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5em;
            user-select: none;
        }

        .food-item:hover {
            transform: scale(1.1);
        }

        .food-item.placed {
            opacity: 0.5;
            pointer-events: none;
        }

        .lock-container {
            text-align: center;
            padding: 40px 20px;
        }

        .combination-lock {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .key-slot {
            width: 80px;
            height: 80px;
            border: 3px solid #2a5298;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .key-slot.filled {
            background: linear-gradient(135deg, #ffd700, #ffeb3b);
            border-color: #28a745;
            transform: scale(1.1);
        }

        .available-keys {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .draggable-key {
            font-size: 2em;
            padding: 10px;
            background: #ffd700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .draggable-key:hover {
            transform: scale(1.1);
        }

        .draggable-key.used {
            opacity: 0.3;
            pointer-events: none;
        }

        .action-btn {
            background: linear-gradient(135deg, #2a5298, #28a745);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .action-btn:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .success-message {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
        }

        .educational-note {
            background: #e8f4f8;
            border: 2px solid #2a5298;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-style: italic;
            color: #2a5298;
        }

        .start-screen {
            text-align: center;
        }

        .start-btn {
            background: linear-gradient(135deg, #ffd700, #2a5298);
            color: white !important;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .celebration-screen {
            text-align: center;
            padding: 20px;
        }

        .scrooge-transformation {
            font-size: 5em;
            margin: 20px 0;
            animation: transform 2s ease-in-out;
        }

        @keyframes transform {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1); }
        }

        .snow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .snowflake {
            position: absolute;
            top: -10px;
            animation: snow-fall linear infinite;
            user-select: none;
        }

        @keyframes snow-fall {
            0% { transform: translateY(-100vh) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(360deg); }
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .progress-container {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .sharing-game {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .combination-lock {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .key-slot {
                width: 60px;
                height: 60px;
                font-size: 2em;
            }

            .restart-fixed {
                top: 15px;
                right: 15px;
                padding: 8px 12px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <button class="restart-fixed" onclick="restartGame()">🔄 Restart</button>
        
        <div class="header">
            <div class="school-logo">🏫 Archbishop Ilsley Catholic School</div>
            <h1>🗝️ Christmas Carol Escape Room</h1>
            <div class="subtitle">Help the Three Spirits Save Scrooge's Soul</div>
        </div>

        <div class="progress-container">
            <div class="ghost-status">
                <div class="ghost-icon" id="pastGhost">👻</div>
                <div class="ghost-label">Christmas Past</div>
                <div class="key-collected" id="pastKey">🗝️</div>
            </div>
            <div class="ghost-status">
                <div class="ghost-icon" id="presentGhost">🎅</div>
                <div class="ghost-label">Christmas Present</div>
                <div class="key-collected" id="presentKey">🎁</div>
            </div>
            <div class="ghost-status">
                <div class="ghost-icon" id="futureGhost">⚰️</div>
                <div class="ghost-label">Christmas Future</div>
                <div class="key-collected" id="futureKey">🔮</div>
            </div>
        </div>

        <!-- Start Screen -->
        <div class="game-screen active" id="startScreen">
            <div class="start-screen">
                <div class="puzzle-instruction">
                    🚨 <strong>Emergency at Scrooge's House!</strong> 🚨<br><br>
                    The three Christmas Spirits have lost their power and can't reach Scrooge's heart! 
                    You must help each spirit complete their mission by solving puzzles. 
                    Only then can Scrooge be saved from his terrible fate.
                </div>
                
                <div class="educational-note">
                    <strong>How to Play:</strong><br>
                    • Solve puzzles to help each of the three Christmas Spirits<br>
                    • Earn keys by completing each spirit's challenge<br>
                    • Use all three keys to unlock Scrooge's redemption<br>
                    • Learn about Dickens' themes through interactive problem-solving!
                </div>

                <div class="educational-note">
                    <strong>Educational Focus:</strong> Character development, cause-and-effect, Victorian social issues, and the power of redemption in Dickens' masterpiece.
                </div>
                <button class="start-btn" onclick="startGame()">🎯 Enter the Escape Room</button>
            </div>
        </div>

        <!-- Ghost of Christmas Past -->
        <div class="game-screen" id="pastScreen">
            <div class="puzzle-header">
                <div class="ghost-title">👻 Ghost of Christmas Past - Memory Chamber</div>
                <div class="puzzle-instruction">
                    The Ghost of Christmas Past has lost pieces of Scrooge's memories! 
                    Help reconstruct his life story by putting these key moments in chronological order.
                </div>
            </div>

            <div class="timeline-container" id="timelineCards">
                <div class="timeline-card" data-order="1">📚 Young Scrooge alone at school during Christmas</div>
                <div class="timeline-card" data-order="2">🎉 Happy times as apprentice with kind Mr Fezziwig</div>
                <div class="timeline-card" data-order="3">💍 Belle agrees to marry young, hopeful Scrooge</div>
                <div class="timeline-card" data-order="4">💰 Scrooge becomes obsessed with making money</div>
                <div class="timeline-card" data-order="5">💔 Belle leaves him: "Another idol has displaced me"</div>
                <div class="timeline-card" data-order="6">🏠 Scrooge becomes a lonely, bitter miser</div>
            </div>

            <div class="puzzle-area">
                <h3 style="text-align: center; margin-bottom: 20px;">Arrange Scrooge's Life Story (Click in Order):</h3>
                <div id="timelineResult" style="min-height: 100px; text-align: center; font-size: 1.1em;"></div>
            </div>

            <div style="text-align: center;">
                <button class="action-btn" onclick="resetTimeline()">🔄 Reset Timeline</button>
                <button class="action-btn" id="checkTimelineBtn" onclick="checkTimeline()" disabled>✅ Check Order</button>
            </div>
        </div>

        <!-- Ghost of Christmas Present -->
        <div class="game-screen" id="presentScreen">
            <div class="puzzle-header">
                <div class="ghost-title">🎅 Ghost of Christmas Present - Sharing Challenge</div>
                <div class="puzzle-instruction">
                    The Ghost of Christmas Present's magic is fading! Help the Cratchit family share their Christmas meal fairly. 
                    Drag food items to each family member - everyone must get something!
                </div>
            </div>

            <div class="sharing-game">
                <div>
                    <h3 style="text-align: center; margin-bottom: 20px;">Available Food:</h3>
                    <div class="food-items" id="availableFood">
                        <div class="food-item" draggable="true" data-food="turkey">🦃</div>
                        <div class="food-item" draggable="true" data-food="potato">🥔</div>
                        <div class="food-item" draggable="true" data-food="bread">🍞</div>
                        <div class="food-item" draggable="true" data-food="apple">🍎</div>
                        <div class="food-item" draggable="true" data-food="cake">🍰</div>
                        <div class="food-item" draggable="true" data-food="pie">🥧</div>
                    </div>
                </div>

                <div>
                    <h3 style="text-align: center; margin-bottom: 20px;">The Cratchit Family:</h3>
                    <div class="family-member" id="bobCratchit" ondrop="drop(event)" ondragover="allowDrop(event)">
                        👨 <strong>Bob Cratchit</strong> (Father)<br>
                        <div class="drop-zone" data-member="bob">Drop food here</div>
                    </div>
                    <div class="family-member" id="mrscratchit" ondrop="drop(event)" ondragover="allowDrop(event)">
                        👩 <strong>Mrs Cratchit</strong> (Mother)<br>
                        <div class="drop-zone" data-member="mrs">Drop food here</div>
                    </div>
                    <div class="family-member" id="tinyTim" ondrop="drop(event)" ondragover="allowDrop(event)">
                        👦 <strong>Tiny Tim</strong> (Youngest)<br>
                        <div class="drop-zone" data-member="tim">Drop food here</div>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="action-btn" onclick="resetSharing()">🔄 Reset Meal</button>
                <button class="action-btn" id="checkSharingBtn" onclick="checkSharing()" disabled>✅ Check Sharing</button>
            </div>
        </div>

        <!-- Ghost of Christmas Future -->
        <div class="game-screen" id="futureScreen">
            <div class="puzzle-header">
                <div class="ghost-title">⚰️ Ghost of Christmas Yet to Come - Future Prevention</div>
                <div class="puzzle-instruction">
                    The Ghost of Christmas Yet to Come shows a terrible future! 
                    Match each of Scrooge's current bad actions with what they lead to in the future.
                </div>
            </div>

            <div class="puzzle-area">
                <h3 style="text-align: center; margin-bottom: 20px;">Connect Actions to Consequences:</h3>
                <div id="consequenceGame">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0;">
                        <div>
                            <h4 style="color: #c41e3a; margin-bottom: 15px;">Current Bad Actions:</h4>
                            <div class="timeline-card consequence-action" data-action="charity" style="margin: 10px 0;">
                                Refuses to give money to charity
                            </div>
                            <div class="timeline-card consequence-action" data-action="salary" style="margin: 10px 0;">
                                Pays Bob Cratchit very little
                            </div>
                            <div class="timeline-card consequence-action" data-action="cold" style="margin: 10px 0;">
                                Won't pay for office heating
                            </div>
                        </div>
                        <div>
                            <h4 style="color: #2a5298; margin-bottom: 15px;">Future Consequences:</h4>
                            <div class="drop-zone consequence-result" data-result="charity" style="margin: 10px 0;">
                                Dies unmourned - nobody cares
                            </div>
                            <div class="drop-zone consequence-result" data-result="salary" style="margin: 10px 0;">
                                Tiny Tim dies from illness
                            </div>
                            <div class="drop-zone consequence-result" data-result="cold" style="margin: 10px 0;">
                                Bob Cratchit becomes sick
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="action-btn" onclick="resetConsequences()">🔄 Reset Connections</button>
                <button class="action-btn" id="checkConsequencesBtn" onclick="checkConsequences()" disabled>✅ Check Connections</button>
            </div>
        </div>

        <!-- Final Lock Screen -->
        <div class="game-screen" id="lockScreen">
            <div class="lock-container">
                <div class="ghost-title">🔓 The Redemption Lock</div>
                <div class="puzzle-instruction">
                    Excellent work! You've helped all three spirits and earned their keys. 
                    Now place the keys in the correct order to unlock Scrooge's heart: Past → Present → Future
                </div>

                <div class="combination-lock">
                    <div class="key-slot" id="slot1" data-slot="past" onclick="selectSlot('slot1')">
                        <div style="font-size: 0.4em; color: #666;">PAST</div>
                    </div>
                    <div class="key-slot" id="slot2" data-slot="present" onclick="selectSlot('slot2')">
                        <div style="font-size: 0.4em; color: #666;">PRESENT</div>
                    </div>
                    <div class="key-slot" id="slot3" data-slot="future" onclick="selectSlot('slot3')">
                        <div style="font-size: 0.4em; color: #666;">FUTURE</div>
                    </div>
                </div>

                <div class="available-keys">
                    <div class="draggable-key" id="keyPast" data-key="past" onclick="placeKey('past')">🗝️</div>
                    <div class="draggable-key" id="keyPresent" data-key="present" onclick="placeKey('present')">🎁</div>
                    <div class="draggable-key" id="keyFuture" data-key="future" onclick="placeKey('future')">🔮</div>
                </div>

                <div style="margin: 30px 0;">
                    <button class="action-btn" onclick="resetLock()">🔄 Reset Lock</button>
                    <button class="action-btn" id="unlockBtn" onclick="unlockRedemption()" disabled>🔓 Unlock Redemption!</button>
                </div>
            </div>
        </div>

        <!-- Success Screen -->
        <div class="game-screen" id="successScreen">
            <div class="celebration-screen">
                <div class="snow" id="snowContainer"></div>
                <div class="ghost-title">🎄 Scrooge is Saved! 🎄</div>
                
                <div class="scrooge-transformation">😠 → 😐 → 🙂 → 😊 → 🎅</div>
                
                <div class="success-message">
                    Magnificent work! You've helped the three spirits complete their missions and saved Scrooge's soul. 
                    Through your problem-solving, you've learned how past experiences, present actions, and future consequences 
                    are all connected in Dickens' masterpiece.
                </div>

                <div class="educational-note">
                    <strong>What You've Discovered:</strong><br>
                    • <strong>Past:</strong> Our experiences shape who we become, but they don't define our future<br>
                    • <strong>Present:</strong> Small acts of kindness and sharing create joy for everyone<br>
                    • <strong>Future:</strong> Our current choices determine what tomorrow will bring<br><br>
                    Dickens wrote A Christmas Carol to show that redemption is always possible - no matter how lost someone seems, 
                    they can change through understanding their past, embracing compassion in the present, and taking responsibility for their future.
                </div>

                <div style="margin-top: 30px;">
                    <button class="action-btn" onclick="restartGame()">🎯 Play Again</button>
                    <button class="action-btn" onclick="showLearningObjectives()">📚 Learning Summary</button>
                </div>
            </div>
        </div>

        <!-- Learning Summary -->
        <div class="game-screen" id="learningScreen">
            <div class="ghost-title">📚 A Christmas Carol - Learning Objectives Achieved</div>
            
            <div style="display: grid; gap: 20px; margin: 20px 0;">
                <div class="educational-note">
                    <strong>🔍 Character Analysis Skills:</strong><br>
                    By reconstructing Scrooge's timeline, you've practised identifying key character development moments and understanding cause-and-effect in literature.
                </div>

                <div class="educational-note">
                    <strong>🤝 Social Responsibility Themes:</strong><br>
                    The sharing game demonstrated Victorian poverty and how small acts of kindness can impact entire families - a key message in Dickens' social criticism.
                </div>

                <div class="educational-note">
                    <strong>📈 Consequence Recognition:</strong><br>
                    Connecting actions to outcomes helps understand how Dickens structured his moral argument about personal responsibility and social change.
                </div>

                <div class="educational-note">
                    <strong>🎭 Victorian Context:</strong><br>
                    Through the puzzles, you've explored the real social conditions Dickens was writing about - workhouses, poor wages, and class divisions.
                </div>

                <div class="educational-note">
                    <strong>📖 Literary Techniques:</strong><br>
                    You've experienced Dickens' use of symbolism (the three spirits), moral allegory, and narrative structure in an interactive way.
                </div>
            </div>

            <div class="success-message">
                These skills transfer directly to GCSE English Literature analysis, essay writing, and understanding how classic texts remain relevant to modern social issues.
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="action-btn" onclick="restartGame()">🎯 Play Again</button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            currentScreen: 'startScreen',
            completedChallenges: {
                past: false,
                present: false,
                future: false
            },
            timelineOrder: [],
            selectedSlot: null,
            lockState: {
                past: false,
                present: false,
                future: false
            }
        };

        // Timeline puzzle data
        const timelineCards = document.querySelectorAll('.timeline-card');
        const timelineResult = document.getElementById('timelineResult');
        let selectedCards = [];

        // Sharing game data
        let sharingState = {
            bob: null,
            mrs: null,
            tim: null
        };

        // Consequence game data
        let consequenceConnections = {};

        // Initialize game
        function startGame() {
            showScreen('pastScreen');
            initializeTimeline();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            gameState.currentScreen = screenId;
        }

        function restartGame() {
            // Reset all game state
            gameState = {
                currentScreen: 'startScreen',
                completedChallenges: {
                    past: false,
                    present: false,
                    future: false
                },
                timelineOrder: [],
                selectedSlot: null,
                lockState: {
                    past: false,
                    present: false,
                    future: false
                }
            };
            
            selectedCards = [];
            sharingState = { bob: null, mrs: null, tim: null };
            consequenceConnections = {};
            
            // Reset visual elements
            resetTimeline();
            resetSharing();
            resetConsequences();
            resetLock();
            
            // Remove any continue buttons that were added
            document.querySelectorAll('.action-btn').forEach(btn => {
                if (btn.textContent.includes('Continue') || btn.textContent.includes('Go to Final')) {
                    btn.remove();
                }
            });
            
            // Reset ghost status
            document.querySelectorAll('.ghost-icon').forEach(icon => {
                icon.classList.remove('complete');
            });
            document.querySelectorAll('.key-collected').forEach(key => {
                key.classList.remove('show');
            });
            
            showScreen('startScreen');
        }

        // TIMELINE PUZZLE (Christmas Past)
        function initializeTimeline() {
            timelineCards.forEach(card => {
                card.addEventListener('click', function() {
                    selectTimelineCard(this);
                });
            });
        }

        function selectTimelineCard(card) {
            if (card.classList.contains('correct') || card.classList.contains('selected')) return;
            
            console.log('Selecting card:', card.textContent.substring(0, 30) + '...', 'Order:', card.dataset.order);
            
            card.classList.add('selected');
            selectedCards.push(card);
            
            const order = selectedCards.length;
            const text = card.textContent;
            
            timelineResult.innerHTML += `<div style="margin: 5px 0; padding: 10px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2a5298;">
                <strong>Step ${order}:</strong> ${text}
            </div>`;
            
            card.style.opacity = '0.7';
            card.style.pointerEvents = 'none';
            
            console.log('Selected cards so far:', selectedCards.length);
            
            const checkBtn = document.getElementById('checkTimelineBtn');
            if (selectedCards.length >= 6) {
                checkBtn.disabled = false;
                checkBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                console.log('Check button enabled');
            }
        }

        function resetTimeline() {
            console.log('Resetting timeline');
            selectedCards = [];
            timelineResult.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">Click cards in chronological order...</p>';
            
            timelineCards.forEach(card => {
                card.classList.remove('selected', 'correct');
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
            });
            
            const checkBtn = document.getElementById('checkTimelineBtn');
            checkBtn.disabled = true;
            checkBtn.style.background = 'linear-gradient(135deg, #2a5298, #28a745)';
        }

        function checkTimeline() {
            console.log('Checking timeline...'); // Debug
            console.log('Selected cards:', selectedCards.map(card => ({
                text: card.textContent.substring(0, 30) + '...',
                order: card.dataset.order
            })));
            
            let correct = true;
            selectedCards.forEach((card, index) => {
                const expectedOrder = parseInt(card.dataset.order);
                const actualPosition = index + 1;
                console.log(`Card ${actualPosition}: expected order ${expectedOrder}, actual position ${actualPosition}`);
                if (expectedOrder !== actualPosition) {
                    correct = false;
                }
            });
            
            console.log('Timeline correct:', correct);
            
            if (correct) {
                selectedCards.forEach(card => {
                    card.classList.add('correct');
                });
                
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.style.margin = '20px 0';
                successMsg.innerHTML = '🎉 Perfect! You\'ve reconstructed Scrooge\'s life story correctly!';
                timelineResult.appendChild(successMsg);
                
                setTimeout(() => {
                    completePastChallenge();
                }, 2000);
            } else {
                alert('Not quite right! Remember the chronological order:\n1. Lonely school days\n2. Happy apprentice times\n3. Engagement to Belle\n4. Obsession with money\n5. Belle leaves him\n6. Becomes a miser\n\nTry again!');
                resetTimeline();
            }
        }

        function completePastChallenge() {
            gameState.completedChallenges.past = true;
            document.getElementById('pastGhost').classList.add('complete');
            document.getElementById('pastKey').classList.add('show');
            
            // Add continue button
            const continueBtn = document.createElement('button');
            continueBtn.className = 'action-btn';
            continueBtn.innerHTML = '➡️ Continue to Christmas Present';
            continueBtn.style.fontSize = '1.2em';
            continueBtn.style.margin = '20px auto';
            continueBtn.style.display = 'block';
            continueBtn.onclick = () => {
                showScreen('presentScreen');
                initializeSharing();
            };
            
            document.getElementById('pastScreen').appendChild(continueBtn);
        }

        // SHARING GAME (Christmas Present)
        function initializeSharing() {
            const foodItems = document.querySelectorAll('.food-item');
            
            foodItems.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.food);
                    e.dataTransfer.setData('text/html', this.outerHTML);
                });
            });
        }

        function allowDrop(e) {
            e.preventDefault();
            e.currentTarget.querySelector('.drop-zone').classList.add('highlight');
        }

        function drop(e) {
            e.preventDefault();
            const dropZone = e.currentTarget.querySelector('.drop-zone');
            dropZone.classList.remove('highlight');
            
            if (dropZone.classList.contains('filled')) return;
            
            const foodType = e.dataTransfer.getData('text/plain');
            const member = dropZone.dataset.member;
            
            sharingState[member] = foodType;
            
            const foodEmoji = {
                'turkey': '🦃',
                'potato': '🥔', 
                'bread': '🍞',
                'apple': '🍎',
                'cake': '🍰',
                'pie': '🥧'
            };
            
            dropZone.textContent = foodEmoji[foodType];
            dropZone.classList.add('filled');
            
            // Mark original food item as placed
            const originalFood = document.querySelector(`[data-food="${foodType}"]`);
            originalFood.classList.add('placed');
            
            // Check if all family members have food
            const allFed = Object.values(sharingState).every(food => food !== null);
            document.getElementById('checkSharingBtn').disabled = !allFed;
        }

        function resetSharing() {
            sharingState = { bob: null, mrs: null, tim: null };
            
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.textContent = 'Drop food here';
                zone.classList.remove('filled', 'highlight');
            });
            
            document.querySelectorAll('.food-item').forEach(item => {
                item.classList.remove('placed');
            });
            
            document.getElementById('checkSharingBtn').disabled = true;
        }

        function checkSharing() {
            // Everyone has food - that's what matters for the spirit of sharing
            completePresentChallenge();
        }

        function completePresentChallenge() {
            gameState.completedChallenges.present = true;
            document.getElementById('presentGhost').classList.add('complete');
            document.getElementById('presentKey').classList.add('show');
            
            // Add continue button
            const continueBtn = document.createElement('button');
            continueBtn.className = 'action-btn';
            continueBtn.innerHTML = '➡️ Continue to Christmas Future';
            continueBtn.style.fontSize = '1.2em';
            continueBtn.style.margin = '20px auto';
            continueBtn.style.display = 'block';
            continueBtn.onclick = () => {
                showScreen('futureScreen');
                initializeConsequences();
            };
            
            document.getElementById('presentScreen').appendChild(continueBtn);
        }

        // CONSEQUENCE GAME (Christmas Future)
        function initializeConsequences() {
            const actions = document.querySelectorAll('.consequence-action');
            
            actions.forEach(action => {
                action.addEventListener('click', function() {
                    selectConsequenceAction(this);
                });
            });
            
            const results = document.querySelectorAll('.consequence-result');
            results.forEach(result => {
                result.addEventListener('click', function() {
                    connectConsequence(this);
                });
            });
        }

        let selectedAction = null;

        function selectConsequenceAction(action) {
            // Clear previous selections
            document.querySelectorAll('.consequence-action').forEach(a => {
                a.classList.remove('selected');
            });
            
            action.classList.add('selected');
            selectedAction = action.dataset.action;
        }

        function connectConsequence(result) {
            if (!selectedAction) {
                alert('First select an action, then click its consequence!');
                return;
            }
            
            const resultType = result.dataset.result;
            
            if (selectedAction === resultType) {
                result.classList.add('filled');
                result.style.border = '2px solid #28a745';
                consequenceConnections[selectedAction] = resultType;
                
                // Clear selection
                document.querySelectorAll('.consequence-action').forEach(a => {
                    a.classList.remove('selected');
                });
                selectedAction = null;
                
                // Check if all connections made
                const allConnected = Object.keys(consequenceConnections).length === 3;
                document.getElementById('checkConsequencesBtn').disabled = !allConnected;
            } else {
                alert('That\'s not quite right. Think carefully about how each action leads to its consequence.');
            }
        }

        function resetConsequences() {
            consequenceConnections = {};
            selectedAction = null;
            
            document.querySelectorAll('.consequence-action').forEach(action => {
                action.classList.remove('selected');
            });
            
            document.querySelectorAll('.consequence-result').forEach(result => {
                result.classList.remove('filled');
                result.style.border = '2px dashed #2a5298';
            });
            
            document.getElementById('checkConsequencesBtn').disabled = true;
        }

        function checkConsequences() {
            completeFutureChallenge();
        }

        function completeFutureChallenge() {
            gameState.completedChallenges.future = true;
            document.getElementById('futureGhost').classList.add('complete');
            document.getElementById('futureKey').classList.add('show');
            
            // Add continue button
            const continueBtn = document.createElement('button');
            continueBtn.className = 'action-btn';
            continueBtn.innerHTML = '🔓 Go to Final Lock Challenge';
            continueBtn.style.fontSize = '1.2em';
            continueBtn.style.margin = '20px auto';
            continueBtn.style.display = 'block';
            continueBtn.onclick = () => {
                showScreen('lockScreen');
                initializeLock();
            };
            
            document.getElementById('futureScreen').appendChild(continueBtn);
        }

        // FINAL LOCK PUZZLE
        function initializeLock() {
            // Keys should only be available if challenges are complete
            if (!gameState.completedChallenges.past) {
                document.getElementById('keyPast').style.display = 'none';
            }
            if (!gameState.completedChallenges.present) {
                document.getElementById('keyPresent').style.display = 'none';
            }
            if (!gameState.completedChallenges.future) {
                document.getElementById('keyFuture').style.display = 'none';
            }
        }

        function selectSlot(slotId) {
            document.querySelectorAll('.key-slot').forEach(slot => {
                slot.style.border = '3px solid #2a5298';
            });
            
            document.getElementById(slotId).style.border = '3px solid #c41e3a';
            gameState.selectedSlot = slotId;
        }

        function placeKey(keyType) {
            if (!gameState.selectedSlot) {
                alert('First click on a lock slot, then click a key!');
                return;
            }
            
            const slot = document.getElementById(gameState.selectedSlot);
            const slotType = slot.dataset.slot;
            
            if (keyType === slotType) {
                const keyEmojis = {
                    'past': '🗝️',
                    'present': '🎁',
                    'future': '🔮'
                };
                
                slot.innerHTML = keyEmojis[keyType];
                slot.classList.add('filled');
                gameState.lockState[keyType] = true;
                
                document.getElementById(`key${keyType.charAt(0).toUpperCase() + keyType.slice(1)}`).classList.add('used');
                
                // Check if all keys placed
                const allKeysPlaced = Object.values(gameState.lockState).every(placed => placed);
                document.getElementById('unlockBtn').disabled = !allKeysPlaced;
                
                gameState.selectedSlot = null;
                slot.style.border = '3px solid #28a745';
            } else {
                alert('That key doesn\'t fit this slot! Remember: Past → Present → Future');
            }
        }

        function resetLock() {
            gameState.lockState = { past: false, present: false, future: false };
            gameState.selectedSlot = null;
            
            document.querySelectorAll('.key-slot').forEach(slot => {
                slot.innerHTML = `<div style="font-size: 0.4em; color: #666;">${slot.dataset.slot.toUpperCase()}</div>`;
                slot.classList.remove('filled');
                slot.style.border = '3px solid #2a5298';
            });
            
            document.querySelectorAll('.draggable-key').forEach(key => {
                key.classList.remove('used');
            });
            
            document.getElementById('unlockBtn').disabled = true;
        }

        function unlockRedemption() {
            showScreen('successScreen');
            createSnowfall();
        }

        function createSnowfall() {
            const snowContainer = document.getElementById('snowContainer');
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const snowflake = document.createElement('div');
                    snowflake.className = 'snowflake';
                    snowflake.innerHTML = '❄️';
                    snowflake.style.left = Math.random() * 100 + '%';
                    snowflake.style.fontSize = Math.random() * 20 + 10 + 'px';
                    snowflake.style.animationDuration = Math.random() * 3 + 2 + 's';
                    snowflake.style.opacity = Math.random();
                    
                    snowContainer.appendChild(snowflake);
                    
                    // Remove snowflake after animation
                    setTimeout(() => {
                        if (snowflake.parentNode) {
                            snowflake.parentNode.removeChild(snowflake);
                        }
                    }, 5000);
                }, i * 100);
            }
        }

        function showLearningObjectives() {
            showScreen('learningScreen');
        }
    </script>
</body>
</html>
